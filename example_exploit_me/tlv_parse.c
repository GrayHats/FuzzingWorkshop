#include <stdlib.h>
#include <stdio.h>
#include "tlv_parse.h"

char * parse_length(unsigned int * size, char * buffer) {
    printf("Size: %hu\n", *size);
    if((unsigned short)*size < MAX_SIZE) {
	buffer += 4;
	char data[MAX_SIZE];
	memcpy(data, buffer, *size);
	printf("Data: %s\n", data);
	buffer += (unsigned short)*size-1;
	printf("---------------------\n");
	return buffer;
    }else{
       printf("Length '%hu' not permitted!\n", (unsigned short)*size);
       exit(EXIT_FAILURE);
    }
}

void parse_file(char * data) {
    printf("---------------------\n");
    int counter = 0;
    for(char * c = data; *c != '\0'; c++) {
	switch(*c) {
            case ID_UNKNOWN:
                printf("Tag: UNKNOWN\n");
		c++;
		c = parse_length((unsigned int *)c, c);
                break;
            case ID_FOLDER:
                printf("Tag: FOLDER\n");
		c++;
		c = parse_length((unsigned int *)c, c);
                break;
        }
    }
}

int main(int argc, char **argv) { 

    char * buffer;    

    if(argc == 2) {
       buffer = read_file(argv[1]);
       parse_file(buffer);
    }
}
